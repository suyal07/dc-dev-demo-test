{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "resourceGroups": {
      "type": "array",
      "metadata": {
        "description": "List of resource groups to create"
      }
    },
    "storageAccounts": {
      "type": "array",
      "metadata": {
        "description": "List of storage accounts to create"
      }
    },
    "logAnalyticsWorkspaces": {
      "type": "array",
      "metadata": {
        "description": "List of Log Analytics workspaces to create, with only workspaceName parameterized"
      }
    }
  },
  "variables": {
    "logAnalyticsTemplateUri": "[uri(deployment().properties.templateLink.uri, 'loganalytics.json')]"
  },
  "resources": [
    // Deploy Resource Groups
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2022-09-01",
      "name": "[parameters('resourceGroups')[0].name]",
      "location": "[parameters('resourceGroups')[0].location]",
      "properties": {}
    },
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2022-09-01",
      "name": "[parameters('resourceGroups')[1].name]",
      "location": "[parameters('resourceGroups')[1].location]",
      "properties": {}
    },
    // Deploy Storage Accounts
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2022-09-01",
      "name": "[parameters('storageAccounts')[0].name]",
      "location": "[parameters('resourceGroups')[1].location]",
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroups')[1].name)]"
      ],
      "properties": {
        "allowBlobPublicAccess": false,
        "minimumTlsVersion": "TLS1_2",
        "deleteRetentionPolicy": {
          "enabled": true,
          "days": "[parameters('storageAccounts')[0].blobSoftDeleteRetentionDays]"
        },
        "containerDeleteRetentionPolicy": {
          "enabled": true,
          "days": "[parameters('storageAccounts')[0].containerSoftDeleteRetentionDays]"
        }
      }
    },
    {
      "type": "Microsoft.Storage/storageAccounts",
      "apiVersion": "2022-09-01",
      "name": "[parameters('storageAccounts')[1].name]",
      "location": "[parameters('resourceGroups')[1].location]",
      "sku": {
        "name": "Standard_LRS"
      },
      "kind": "StorageV2",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/resourceGroups', parameters('resourceGroups')[1].name)]"
      ],
      "properties": {
        "allowBlobPublicAccess": false,
        "minimumTlsVersion": "TLS1_2",
        "deleteRetentionPolicy": {
          "enabled": true,
          "days": "[parameters('storageAccounts')[1].blobSoftDeleteRetentionDays]"
        },
        "containerDeleteRetentionPolicy": {
          "enabled": true,
          "days": "[parameters('storageAccounts')[1].containerSoftDeleteRetentionDays]"
        }
      }
    },
    // Deploy Log Analytics Workspace via Nested Deployment
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "logAnalyticsDeployment",
      "resourceGroup": "[parameters('logAnalyticsWorkspaces')[0].resourceGroup]",
      "dependsOn": [
        "[resourceId('Microsoft.Resources/resourceGroups', parameters('logAnalyticsWorkspaces')[0].resourceGroup)]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('logAnalyticsTemplateUri')]",
          "contentVersion": "1.0.0.0"
        },
        "parameters": {
          "workspaceName": {
            "value": "[parameters('logAnalyticsWorkspaces')[0].workspaceName]"
          },
          "location": {
            "value": "uksouth"
          },
          "sku": {
            "value": "pergb2018"
          },
          "retentionInDays": {
            "value": 30
          },
          "usageTableRetentionInDays": {
            "value": 90
          },
          "tags": {
            "value": {
              "Application": "datacatalyst-demo",
              "Client": "nowvertical",
              "CostCenter": "123cc",
              "DataSensitivity": "internal",
              "Environment": "dev",
              "Lifecycle": "active",
              "ManagedBy": "nowvertical",
              "Project": "datacatalyst",
              "Region": "uksouth",
              "Solution": "data-integration",
              "Tier": "core",
              "Master_tag": "Technology:DataCatalyst:SMALLAYA:KKNOPP:LogAnalytics:N"
            }
          },
          "enableLogAccessUsingOnlyResourcePermissions": {
            "value": true
          },
          "dailyQuotaGb": {
            "value": -1
          },
          "publicNetworkAccessForIngestion": {
            "value": "Enabled"
          },
          "publicNetworkAccessForQuery": {
            "value": "Enabled"
          }
        }
      }
    }
  ],
  "outputs": {
    "workspaceId": {
      "type": "string",
      "value": "[reference('logAnalyticsDeployment').outputs.workspaceId.value]"
    },
    "storageAccountIds": {
      "type": "array",
      "value": [
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccounts')[0].name)]",
        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageAccounts')[1].name)]"
      ]
    }
  }
}