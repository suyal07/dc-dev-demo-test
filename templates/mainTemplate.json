{
  "$schema": "https://schema.management.azure.com/schemas/2019-04-01/deploymentTemplate.json#",
  "contentVersion": "1.0.0.0",
  "parameters": {
    "resourceGroups": {
      "type": "array",
      "metadata": {
        "description": "List of resource groups to deploy"
      }
    },
    "storageAccounts": {
      "type": "array",
      "metadata": {
        "description": "List of storage accounts to deploy"
      }
    }
  },
  "variables": {
    "storageAccountTemplateUrl": "https://raw.githubusercontent.com/suyal07/dc-dev-demo-test/main/templates/independent/storageAccount.json",
    "sqlServerTemplateUrl": "https://raw.githubusercontent.com/suyal07/dc-dev-demo-test/main/templates/independent/sqlServer.json",
    "logAnalyticsTemplateUrl": "https://raw.githubusercontent.com/suyal07/dc-dev-demo-test/main/templates/independent/logAnalytics.json",
    "containerAppsTemplateUrl": "https://raw.githubusercontent.com/suyal07/dc-dev-demo-test/main/templates/independent/containerApps.json",
    "vnetTemplateUrl": "https://raw.githubusercontent.com/suyal07/dc-dev-demo-test/main/templates/independent/vnet.json",
    "apimTemplateUrl": "https://raw.githubusercontent.com/suyal07/dc-dev-demo-test/main/templates/independent/apim.json",
    "logicAppsTemplateUrl": "https://raw.githubusercontent.com/suyal07/dc-dev-demo-test/main/templates/independent/logicApps.json",
    "alertsLogicAppTemplateUrl": "https://raw.githubusercontent.com/suyal07/dc-dev-demo-test/main/templates/independent/alertsLogicApp.json",
    "functionAppTemplateUrl": "https://raw.githubusercontent.com/suyal07/dc-dev-demo-test/main/templates/dependent/functionApp.json",
    "apiUsageAnalyticsTemplateUrl": "https://raw.githubusercontent.com/suyal07/dc-dev-demo-test/main/templates/dependent/APIUsageAnalytics.json",
    "platformCostInsightsTemplateUrl": "https://raw.githubusercontent.com/suyal07/dc-dev-demo-test/main/templates/dependent/PlatformCostInsights.json",
    "actionGroupApimTemplateUrl": "https://raw.githubusercontent.com/suyal07/dc-dev-demo-test/main/templates/dependent/actionGroupApim.json",
    "resourceGroupLocations": {
      "[parameters('resourceGroups')[0].name]": "[parameters('resourceGroups')[0].location]",
      "[parameters('resourceGroups')[1].name]": "[parameters('resourceGroups')[1].location]"
    }
  },
  "resources": [
    {
      "type": "Microsoft.Resources/resourceGroups",
      "apiVersion": "2021-04-01",
      "name": "[parameters('resourceGroups')[copyIndex()].name]",
      "location": "[parameters('resourceGroups')[copyIndex()].location]",
      "copy": {
        "name": "resourceGroupCopy",
        "count": "[length(parameters('resourceGroups'))]"
      }
    },
    {
      "type": "Microsoft.Resources/deployments",
      "apiVersion": "2022-09-01",
      "name": "[concat('storageAccount-', copyIndex())]",
      "resourceGroup": "[parameters('storageAccounts')[copyIndex()].resourceGroup]",
      "copy": {
        "name": "storageAccountCopy",
        "count": "[length(parameters('storageAccounts'))]"
      },
      "dependsOn": [
        "[concat('Microsoft.Resources/resourceGroups/', parameters('storageAccounts')[copyIndex()].resourceGroup)]"
      ],
      "properties": {
        "mode": "Incremental",
        "templateLink": {
          "uri": "[variables('storageAccountTemplateUrl')]"
        },
        "parameters": {
          "storageAccountName": {
            "value": "[parameters('storageAccounts')[copyIndex()].name]"
          },
          "blobSoftDeleteRetentionDays": {
            "value": "[parameters('storageAccounts')[copyIndex()].blobSoftDeleteRetentionDays]"
          },
          "containerSoftDeleteRetentionDays": {
            "value": "[parameters('storageAccounts')[copyIndex()].containerSoftDeleteRetentionDays]"
          },
          "location": {
            "value": "[parameters('storageAccounts')[copyIndex()].location]"
          }
        }
      }
    }
  ]
}